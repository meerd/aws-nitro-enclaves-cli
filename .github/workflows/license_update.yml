name: Update THIRD_PARTY_LICENSES_RUST_CRATES.html
on:
  schedule:
    # Every ten minutes
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  update_license:
    name: Update THIRD_PARTY_LICENSES_RUST_CRATES.html
    permissions:
      contents: write  
      pull-requests: write  
    if: github.repository == 'meerd/aws-nitro-enclaves-cli'
    runs-on: ubuntu-latest
    steps:
      - uses: dawidd6/action-delete-branch@v3
        with:
          github_token: ${{github.token}}
          branches: rust-crates-license-update
      - uses: actions/checkout@v3.5.0
        with:
          fetch-depth: 0
          persist-credentials: false
      - run: cargo install --locked --version "~0.5" cargo-about
      - run: cargo about generate --workspace --output-file THIRD_PARTY_LICENSES_RUST_CRATES.html about.hbs
      - id: checkgitdiff # Early exit if there is no diff.
        run: |
          git diff --exit-code --quiet
          [ $? -eq 0 ] && {
            echo "There is no diff in the rust license file."
            gh run cancel ${{ github.run_id }}
            gh run watch ${{ github.run_id }}
          }
        continue-on-error: true
      - uses: gr2m/create-or-update-pull-request-action@v1.x
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          author: NitroCLI GitHub Bot <nitrocli@nomail.com>
          branch: rust-crates-license-update
          title: 'doc: update THIRD_PARTY_LICENSES_RUST_CRATES.html'
          body: >
            The license file is out of date. This is an automatically generated PR by
            a GitHub Action.
          commit-message: 'doc: update THIRD_PARTY_LICENSES_RUST_CRATES.html'


